name: Backend CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/backend.yml'
  workflow_dispatch:

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-southeast-2' }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
  EC2_HOST: ${{ vars.EC2_HOST }}
  EC2_USER: ${{ vars.EC2_USER || 'ec2-user' }}

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Run tests
        working-directory: ./backend
        run: ./mvnw test
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: backend/target/surefire-reports/

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: test
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Build with Maven
        working-directory: ./backend
        run: ./mvnw clean package -DskipTests
      
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build, tag, and push Docker image to ECR
        working-directory: ./backend
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --tag $ECR_REPOSITORY:$IMAGE_TAG \
            --tag $ECR_REPOSITORY:latest \
            --push \
            .
          echo "Pushed image: $ECR_REPOSITORY:$IMAGE_TAG"
      
      - name: Deploy to EC2
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Save SSH key
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          # SSH to EC2 and deploy
          ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e
            
            # Configure AWS region
            export AWS_DEFAULT_REGION=${{ env.AWS_REGION }}
            
            # Login to ECR
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.ECR_REPOSITORY }}
            
            # Pull latest image
            docker pull ${{ env.ECR_REPOSITORY }}:latest
            
            # Stop and remove old container
            docker stop jira-backend || true
            docker rm jira-backend || true
            
            # Run new container
            docker run -d \
              --name jira-backend \
              --restart unless-stopped \
              -p 8080:8080 \
              --env-file /home/${{ env.EC2_USER }}/.env \
              ${{ env.ECR_REPOSITORY }}:latest
            
            # Wait for health check
            echo "Waiting for application to start..."
            sleep 15
            
            # Health check
            if curl -f http://localhost:8080/api/health; then
              echo "âœ… Deployment successful!"
            else
              echo "âŒ Health check failed!"
              exit 1
            fi
          ENDSSH
          
          # Clean up SSH key
          rm -f private_key.pem
      
      - name: Deployment summary
        run: |
          echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`$ECR_REPOSITORY:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: \`$EC2_HOST\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **API URL**: http://$EC2_HOST:8080" >> $GITHUB_STEP_SUMMARY
